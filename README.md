# The Material Editor Exterminatus

Аддон для Blender 4.4+, который автоматически находит, анализирует и управляет неиспользуемыми узлами в материалах.

## Возможности

### Поиск неиспользуемых узлов
- **Автоматическое обнаружение** узлов, не связанных с выходными узлами
- **Рекурсивный анализ** групповых узлов и их содержимого
- **Поддержка всех типов** выходных узлов (Material Output, World Output, Light Output)
- **Умная трассировка** связей от выходных узлов к используемым

### Расширенная система отчетов
- **Квадратный мини-попап** с основной статистикой
- **Полный отчет в консоль** с детальной информацией
- **Текстовый блок** в Blender с форматированием
- **Автоматическое сохранение** на диск в папку reports
- **Отдельное окно** с терминалом сверху и текстовым редактором снизу
- **Анализ подключения групп** к выходным узлам материалов

### Группировка и организация
- **Создание фрейма "UNUSED"** с неиспользуемыми узлами
- **Умное размещение** слева от используемых узлов
- **Автоматическое добавление атрибутов** только к узлам с свободными входами
- **Настройка типа атрибута** (Geometry, Object, Instancer, View Layer)
- **Выбор канала данных** (Color, Vector, Fac, Alpha)
- **Управление отображением атрибутов** в отчетах
- **Сеточное расположение** узлов для оптимального использования пространства

### Удаление узлов
- **Безопасное удаление** неиспользуемых узлов
- **Поддержка активного дерева** и всех материалов
- **Необратимая операция** с предупреждениями

## Демонстрация работы

![Демо работы аддона](assets/demo.gif)


## Установка

### Требования
- Blender 4.4 или выше
- Python 3.10+

### Процесс установки
1. Скачайте файлы аддона
2. В Blender перейдите в `Edit > Preferences > Add-ons`
3. Нажмите `Install...` и выберите файл `blender_manifest.toml`
4. Активируйте аддон "The Material Editor Exterminatus"

## Использование

### Основной интерфейс
1. Откройте редактор узлов (Node Editor)
2. В боковой панели найдите вкладку "Unused"
3. Используйте кнопки для различных операций

### Создание отчета
1. Нажмите "Создать расширенный отчет"
2. Появится квадратный попап с основной статистикой
3. Нажмите "Полный отчёт" для детального просмотра
4. Откроется окно с терминалом сверху и текстом снизу

### Группировка узлов
1. Установите текст атрибута в поле "Атрибут"
2. Выберите тип атрибута в выпадающем списке "Тип атрибута":
   - **Geometry**: атрибут в геометрии (по умолчанию)
   - **Object**: атрибут в свойствах объекта
   - **Instancer**: атрибут у инстансера
   - **View Layer**: атрибут из View Layer
3. Выберите канал данных в выпадающем списке "Канал данных":
   - **Color**: цветовой канал (по умолчанию)
   - **Vector**: векторный канал
   - **Fac**: фактор
   - **Alpha**: альфа-канал
4. Установите галочку "Показывать в отчёте атрибуты" для включения атрибутов в отчет
5. Нажмите "Группировать в активном дереве" или "Группировать во всех материалах"
6. Неиспользуемые узлы будут собраны в фрейм "UNUSED"

### Удаление узлов
- **Внимание**: Операция необратима!
- Используйте "Удалить в активном дереве" для текущего материала
- Используйте "Удалить во всех материалах" для глобальной очистки

## Технические особенности

### Алгоритм поиска неиспользуемых узлов
1. **Поиск выходных узлов** - определение всех узлов типа OUTPUT
2. **Трассировка связей** - рекурсивный обход от выходных узлов
3. **Сбор используемых узлов** - все узлы, достижимые от выходных
4. **Вычисление разности** - неиспользуемые = все узлы - используемые

### Рекурсивный анализ групп
- Автоматический обход содержимого групповых узлов
- Учет вложенности групп (группы внутри групп)
- Сбор информации об использовании групп в материалах

### Умная группировка
- Проверка наличия свободных входов перед созданием атрибутов
- Автоматическое размещение в сетке с учетом размеров узлов
- Создание фрейма с оптимальным расположением

### Система отчетов
- **Мини-попап**: основная статистика в квадратном окне
- **Консольный вывод**: детальная информация с форматированием
- **Текстовый блок**: полный отчет в Blender
- **Файловый вывод**: сохранение в папку reports

## Формат отчета

### Консольный вывод
```
============================================================
ОТЧЕТ О НЕИСПОЛЬЗУЕМЫХ УЗЛАХ
============================================================
Создан: 2025-01-27 15:30:45
Проанализировано материалов: 5
[MyMaterial] UnusedNode (BSDF_PRINCIPLED)
[MyMaterial] MyGroup (GROUP)
  → Группа используется в материалах: [Material1, Material2]
  → Подключена к выходу в материалах: [Material1]
[MyMaterial] AnotherGroup (GROUP)
  → Группа используется в материалах: [Material3]
  → НЕ подключена к выходу ни в одном материале
Всего найдено неиспользуемых узлов: 5
============================================================
ИНФОРМАЦИЯ О СОХРАНЕНИИ:
Файл на диске: reports/unused_nodes_report.txt
Текстовый блок: unused_nodes_report
============================================================
```

### Структура данных
```python
{
    node: {
        "type": "BSDF_PRINCIPLED",
        "materials": ["Material1", "Material2"],  # для групп
        "connected_to_output": ["Material1"],  # для групп - где подключена к выходу
        "parent_tree": "MyMaterial"
    }
}
```

## Архитектура

### Структура файлов
```
MEE_blender_addon/
├── __init__.py              # Основной файл аддона и регистрация
├── operators.py             # Операторы Blender и основная логика
├── ui.py                   # Пользовательский интерфейс
├── utils.py                # Вспомогательные функции и алгоритмы
├── blender_manifest.toml   # Манифест для Blender 4.4+
└── README.md               # Документация
```

### Основные компоненты

#### `operators.py` - Операторы
- `NODE_OT_DeleteUnusedNodes` - удаление в активном дереве
- `NODE_OT_DeleteAllUnusedNodes` - удаление во всех материалах
- `NODE_OT_SimpleReportPopup` - квадратный попап с отчетом
- `NODE_OT_FindUnusedNodesPopup` - создание расширенного отчета
- `TEXT_OT_OpenUnusedNodesReportWindow` - окно с терминалом и текстом
- `NODE_OT_GroupUnusedNodesActive` - группировка в активном дереве
- `NODE_OT_GroupUnusedNodesAll` - группировка во всех материалах

#### `utils.py` - Алгоритмы
- `find_unused_nodes_recursive()` - рекурсивный поиск неиспользуемых узлов
- `collect_group_usage()` - сбор информации об использовании групп
- `traverse_from_outputs()` - трассировка от выходных узлов
- `place_group_left_of_used()` - умное размещение групп
- `layout_nodes_grid()` - сеточное расположение узлов

#### `ui.py` - Интерфейс
- `NODE_PT_unused_nodes` - основная панель в Node Editor
- Минималистичный дизайн без лишних элементов
- Логичный порядок операций: Настройки → Отчеты → Группировка → Удаление

## Крайние случаи

### Обработка ошибок
- **Нет материалов**: "Нет материалов для анализа"
- **Все узлы используются**: "Все ноды используются"
- **Нет выходных узлов**: предупреждение в отчете
- **Пустые группы**: корректная обработка без ошибок

### Валидация данных
- Проверка существования узлов и материалов
- Валидация входных параметров
- Обработка исключений с логированием

## Логирование

### Система логов
- Подробные логи в файле `unused_nodes.log`
- Информация о всех операциях и ошибках
- Временные метки для отладки

### Уровни логирования
- INFO: успешные операции
- WARNING: предупреждения
- ERROR: ошибки с детальными сообщениями

## Совместимость

### Версии Blender
- **Минимальная**: Blender 4.4.0
- **Рекомендуемая**: Blender 4.4+
- **API**: современные вызовы с temp_override

### Типы узлов
- ShaderNodeTree (шейдерные материалы)
- Group nodes (групповые узлы)
- Все типы выходных узлов

## Лицензия

MIT License - см. файл LICENSE для подробностей.

## Поддержка

### При возникновении проблем
1. Проверьте логи в консоли Blender
2. Убедитесь, что используете Blender 4.4+
3. Проверьте, что материалы имеют включенные узлы
4. Изучите файл логов `unused_nodes.log`

### Отладка
- Все операции логируются с временными метками
- Детальная информация об ошибках
- Возможность включения дополнительного логирования

## Изменения в версии 1.0.0

### Основные функции
- Поиск неиспользуемых узлов с рекурсивным анализом групп
- Расширенная система отчетов с множественными форматами вывода
- Умная группировка с проверкой возможности подключения атрибутов
- Безопасное удаление неиспользуемых узлов

### Улучшения интерфейса
- Квадратный мини-попап с основной статистикой
- Отдельное окно отчета с терминалом и текстовым редактором
- Минималистичный UI без лишних элементов
- Логичный порядок операций

### Технические улучшения
- Современный API Blender 4.4+ с temp_override
- Полная типизация кода
- Обработка ошибок с логированием
- Модульная архитектура 
